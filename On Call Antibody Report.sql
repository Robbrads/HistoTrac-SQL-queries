/*Main*/
Select  p.lastnm, p.firstnm, p.dob, p.hospitalid, sample.specimentypecd, sample.sampledt, isnull(test.testtypecd,'') TestTypeCd, test.pracellcd, sample.samplenbr, sample.logtime, test.praresultcd, test.pctposcnt, case isnull(test.specificitytxt,'') when '' then isnull(usertest.cspecificitytxt,'') else isnull(test.specificitytxt,'') end as SpecificityTxt, p.ma1eqcd, p.ma2eqcd, p.mb1eqcd, p.mb2eqcd, p.mbw1eqcd, p.mbw2eqcd, p.mc1eqcd, p.mc2eqcd, p.mdrb11eqcd, p.mdrb12eqcd, p.mdrb31eqcd, p.mdrb32eqcd, p.mdrb41eqcd, p.mdrb42eqcd, p.mdrb51eqcd, p.mdrb52eqcd, p.mdqb11eqcd, p.mdqb12eqcd, p.mdqa11cd, p.mdqa12cd, p.mdpb11cd, p.mdpb12cd, p.mdpa11cd, p.mdpa12cd, testbatch.batchnm, '' Virology, case isnull(test.moderateriskantibodytxt,'') when '' then isnull(usertest.cmoderaterisktxt,'') else isnull(test.moderateriskantibodytxt,'') end as ModRiskAntibodyTxt, case isnull(test.lowriskantibodytxt,'') when '' then isnull(usertest.clowriskantibodytxt,'') else isnull(test.lowriskantibodytxt,'') end as LowRiskAntibodyTxt from patient p inner join sample on p.patientid = sample.patientid inner join test on test.sampleid = sample.sampleid inner join testdefinition on testdefinition.testtypecd = test.testtypecd left join testbatch on testbatch.testbatchid = test.assignedtobatchid left join usertest on usertest.testid = test.testid where p.unosactivatedind = '1'  and testdefinition.testclasscd = 'Antibody' and datediff(d,sampledt,getdate()) <=731 order by sample.sampledt desc, test.testtypecd asc, test.pracellcd asc